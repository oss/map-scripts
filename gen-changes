#!/usr/bin/env python

import urllib
import urllib2
import shutil
import subprocess
import xml.etree.ElementTree as ET
import xml.dom.minidom
from shapely.geometry import Polygon
from shapely.geometry import box
from shapely.wkt import loads
from datetime import datetime
from lxml.cssselect import CSSSelector
import lxml.html

from sys import argv, exit
import smtplib, os, os.path
from email.MIMEMultipart import MIMEMultipart
from email.MIMEText import MIMEText
from email.MIMEBase import MIMEBase
from email.Utils import formatdate
from email import Encoders


import pprint
pp = pprint.PrettyPrinter(indent=4)

def base_api_url(debug=False):
    normal = 'http://api.openstreetmap.org'  
    debug_s = 'http://api06.dev.openstreetmap.org'
    return normal if debug == False else debug_s


def nominatim_url(query, **kwargs):
    nominatimurl = 'http://nominatim.openstreetmap.org/search/'
    if query is not None:
        nominatimurl += query
    if not kwargs:
        return nominatimurl
    nominatimurl += '?'
    for kwarg in kwargs:
        if nominatimurl[len(nominatimurl)-1] != '?':
            nominatimurl += '&'
        nominatimurl += kwarg + '=' + kwargs[kwarg]
    return nominatimurl


def parse_api_url(url):
    f = urllib2.urlopen(url)
    return ET.fromstring(f.read())


def get_by_name(name, format='xml', bbox=None):
    name_search = None
    if bbox is not None:
        str_bbox = ""
        for x in bbox:
            if x == bbox[3]:
                str_bbox += str(x)
            else:
                str_bbox += str(x) + ','
        name_search = parse_api_url(nominatim_url(name,
                                                  format=format,
                                                  viewboxlbrt=str_bbox,
                                                  polygon_text="1"))
    else:
        name_search = parse_api_url(nominatim_url(name, format=format,
                                                  polygon_text="1"))
    return name_search


def print_ET(root):
    print xml.dom.minidom.parseString(ET.tostring(root)).toprettyxml(),


def name_to_polygon(name, bbox=None):
    name_root = get_by_name(urllib.quote(name), bbox=bbox)
    polygon = loads(name_root[0].attrib['geotext'])
    return polygon


def get_change_fp(change):
    return urllib2.urlopen(base_api_url() + '/api/0.6/changeset/' + changeset.attrib['id'] + '/download')


def mkdir_ask(changes):
    ret = []
    for change in changes:
        fname = os.path.join('/army/pending', str(change.attrib['id']) + '.osc')
        if not os.path.isfile(fname):
            f = open(fname, 'w')
            f.write(get_change_fp(change).read())
            f.close()
            ret.append(fname)
    return ret


def send_mail(changes, address):
    msg = MIMEMultipart()
    msg['From'] = 'phantoon'
    msg['To'] = address
    msg['Date'] = formatdate(localtime=True)
    msg['Subject'] = "Changes for Rutgers maps need approval"
    msg.attach(MIMEText("The attached files need approval, run '/usr/bin/commit-changes' on phantoon to allow or deny changes"))
    for change in changes:
        part = MIMEBase('text', 'xml')
        part.set_payload(open(change, "r").read())
        Encoders.encode_base64(part)
        part.add_header('Content-Disposition', 'attachment; filename="{0}"'.format(os.path.basename(change)))
        msg.attach(part)
    smtp = smtplib.SMTP('localhost')
    smtp.sendmail('phantoon', address, msg.as_string())
    smtp.close()


def get_new_jersey(outfile):
    h = lxml.html.fromstring(urllib2.urlopen("http://download.geofabrik.de/north-america/us/new-jersey.html").read())
    table = h.cssselect('table#subregions')[0]
    output = ""
    for tr in table[1:]:
        if tr[0][0].text == "new-jersey-latest.osm.pbf":
            output = tr[1].text
    with open(outfile, 'w') as f:
        f.write(urllib2.urlopen("http://download.geofabrik.de/north-america/us/new-jersey-latest.osm.pbf").read())


def get_bbox(node, bboxes):
    pass


if __name__ == '__main__':

    new_jersey = name_to_polygon("New Jersey")

    rutgers_bbox = [-74.5343, 40.4164, -74.3520, 40.5673]
    busch = name_to_polygon("Rutgers Busch Campus", bbox=rutgers_bbox)
    livi = name_to_polygon("Rutgers Livingston Campus", bbox=rutgers_bbox)
    college_ave = name_to_polygon("Rutgers University - New Brunswick",
                                  bbox=rutgers_bbox)
    rutgers = [busch, livi, college_ave]

    shutil.move('/army/new-jersey-latest.osm.pbf', '/army/new-jersey-old.osm.pbf')
    get_new_jersey('/army/new-jersey-latest.osm.pbf')
    subprocess.call('osmosis', '--read-pbf', 'file="/army/new-jersey-old.osm.pbf"', '--read-pbf', 'file="/army/new-jersey-latest.osm.pbf"', '--derive-change', '--write-xml-change', 'file="/army/diff.osc"')
    os.remove('/army/new-jersey-old.osm.pbf')

    changes = ET.parse('/army/diff.osc')

    osmdate_format = "%Y-%m-%dT%H:%M:%SZ"

    bboxes = {}

    for change in changes:
        for data in change:
            if child.tag == "node":
                lat = int(child.attrib['lat'])
                lon = int(child.attrib['lon'])
                bboxes[child.attrib['id']] = (lat, lon, lat, lon)

    apply_immediately = []
    max_changetime = datetime.min
    ask_permission = []
    closed_changes = [x for x in changesets.findall('changeset') if x.attrib['open'] == "false"]
    for changeset in closed_changes:
        changetime = datetime.strptime(changeset.attrib['closed_at'], osmdate_format)
        if changetime > max_changetime:
            max_changetime = changetime
        p = changeset.attrib
        minx = float(p['min_lon'])
        miny = float(p['min_lat'])
        maxx = float(p['max_lon'])
        maxy = float(p['max_lat'])
        bbox = box(minx, miny, maxx, maxy)
        if bbox.intersects(new_jersey):
            for campus in rutgers:
                if bbox.intersects(campus):
                    ask_permission.append(changeset)
                    break
            if changeset not in ask_permission:
                apply_immediately.append(changeset)
    with open(inputFile, 'w') as f:
        f.write(max_changetime.strftime(osmdate_format))
    for changeset in apply_immediately:
        f = open('/army/changes/' + str(changeset.attrib['id']) + '.osc', 'w')
        f.write(get_change_fp(changeset).read())
        f.close()
    changes = mkdir_ask(ask_permission)
    send_mail(changes, 'mwr54@nbcs.rutgers.edu')
